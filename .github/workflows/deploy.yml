# ═══════════════════════════════════════════════════════════
# Deploy to VPS - Runs on push to main
#
# REQUIRED GITHUB SECRETS:
#   VPS_HOST       - VPS IP or hostname
#   VPS_USERNAME   - SSH user (e.g. root)
#   VPS_SSH_KEY    - Private SSH key (full PEM content)
#   VPS_PORT       - SSH port (e.g. 22)
#   APP_DIR        - Project path on VPS (e.g. /root/notification-service)
# ═══════════════════════════════════════════════════════════

name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript build
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/server.js && test -f dist/worker.js
          echo "Build verified"

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "src/,package.json,package-lock.json,tsconfig.json,Dockerfile,docker-compose.prod.yml,.dockerignore"
          target: ${{ secrets.APP_DIR }}
          overwrite: true
          strip_components: 0

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 20m
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}

            APP_PORT=$(grep -E '^PORT=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '[:space:]')
            APP_PORT=${APP_PORT:-5000}

            COMPOSE="docker compose -f docker-compose.prod.yml"

            # ── Health check with visible diagnostics ────────────────────
            wait_for_health() {
              echo "Waiting for http://localhost:$APP_PORT/health ..."
              for i in $(seq 1 12); do
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$APP_PORT/health 2>/dev/null || echo "000")
                CONTAINER_STATUS=$($COMPOSE ps api --format "{{.Status}}" 2>/dev/null || echo "unknown")
                echo "  attempt $i/12 — HTTP $HTTP_CODE — container: $CONTAINER_STATUS"

                if [ "$HTTP_CODE" = "200" ]; then
                  return 0
                fi

                # Print logs every 3 attempts so we can see startup errors
                if [ $((i % 3)) -eq 0 ]; then
                  echo "  --- api logs (last 10 lines) ---"
                  $COMPOSE logs api --tail=10 2>/dev/null || true
                  echo "  --------------------------------"
                fi

                sleep 5
              done
              return 1
            }

            # ── Snapshot for rollback ────────────────────────────────────
            rm -rf src.backup
            [ -d src ] && cp -r src src.backup && echo "Snapshot saved" || echo "First deploy"

            # ── Rollback ─────────────────────────────────────────────────
            rollback() {
              echo "DEPLOYMENT FAILED — rolling back"
              echo "--- Final api logs ---"
              $COMPOSE logs api --tail=30 2>/dev/null || true

              if [ ! -d src.backup ]; then
                echo "No backup — cannot rollback"
                exit 1
              fi

              rm -rf src && cp -r src.backup src
              $COMPOSE build --no-cache
              $COMPOSE up -d --scale worker=2 --remove-orphans

              if wait_for_health; then
                echo "Rollback successful"
              else
                echo "Rollback also failed — manual intervention required"
              fi
              exit 1
            }

            trap rollback ERR

            # ── Deploy ───────────────────────────────────────────────────
            echo "--- Building ---"
            $COMPOSE build --no-cache

            echo "--- Starting containers ---"
            $COMPOSE up -d --scale worker=2 --remove-orphans

            docker image prune -f

            # ── Verify ───────────────────────────────────────────────────
            if wait_for_health; then
              echo "Deployment successful! Commit: ${{ github.sha }}"
              rm -rf src.backup
            else
              rollback
            fi
