# ═══════════════════════════════════════════════════════════
# Deploy to VPS - Runs on push to main
#
# REQUIRED GITHUB SECRETS (add in repo Settings > Secrets):
#
#   VPS_HOST              - VPS IP or hostname (e.g. 167.99.0.1)
#   VPS_USERNAME          - SSH user (e.g. root or deploy)
#   VPS_SSH_KEY           - Private SSH key (full PEM content)
#   VPS_PORT              - SSH port (e.g. 22)
#   APP_DIR               - Project path on VPS (e.g. /root/notification-service)
#
# NOTE: .env file with all app credentials (MongoDB, Redis, JWT, etc.)
#       must already exist on the VPS at APP_DIR/.env
#
# ROLLBACK STRATEGY:
#   - Before every deploy, the current src/ is snapshotted to src.backup/
#   - If health check fails → backup is restored and containers are restarted
#   - Rollback result is posted as a GitHub commit status
# ═══════════════════════════════════════════════════════════

name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript build
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/server.js && test -f dist/worker.js
          echo "Build verified"

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "src/,package.json,package-lock.json,tsconfig.json,Dockerfile,docker-compose.prod.yml,.dockerignore"
          target: ${{ secrets.APP_DIR }}
          overwrite: true
          strip_components: 0

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}

            APP_PORT=$(grep -E '^PORT=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '[:space:]')
            APP_PORT=${APP_PORT:-5000}

            # ✅ FIXED FOR YOUR VPS (Compose v1)
            COMPOSE="docker-compose -f docker-compose.prod.yml"

            wait_for_health() {
              echo "Waiting for service to be healthy..."
              for i in $(seq 1 15); do
                if curl -sf http://localhost:$APP_PORT/health > /dev/null 2>&1; then
                  echo "Health check passed (attempt $i)"
                  return 0
                fi
                echo "attempt $i/15 — waiting 5s..."
                sleep 5
              done
              echo "Health check failed"
              return 1
            }

            echo "--- Snapshotting current deployment ---"
            rm -rf src.backup
            if [ -d src ]; then
              cp -r src src.backup
            fi

            rollback() {
              echo "DEPLOYMENT FAILED — rollback starting"

              if [ ! -d src.backup ]; then
                echo "No backup found"
                exit 1
              fi

              rm -rf src
              cp -r src.backup src

              $COMPOSE build --no-cache
              $COMPOSE up -d --scale worker=2 --remove-orphans

              if wait_for_health; then
                echo "Rollback successful"
              else
                echo "Rollback failed"
                $COMPOSE logs --tail=50 api
              fi

              exit 1
            }

            trap rollback ERR

            echo "--- Pulling base images ---"
            docker pull mongo:7 || true
            docker pull redis:7-alpine || true

            echo "--- Building new Docker image ---"
            $COMPOSE build --no-cache

            echo "--- Starting new containers ---"
            $COMPOSE up -d --scale worker=2 --remove-orphans

            echo "--- Cleaning old images ---"
            docker image prune -f

            echo "--- Running health check ---"
            if wait_for_health; then
              echo "Deployment successful"
              rm -rf src.backup
            else
              rollback
            fi
