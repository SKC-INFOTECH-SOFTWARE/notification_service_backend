# ═══════════════════════════════════════════════════════════
# Deploy to VPS - Runs on push to main
#
# REQUIRED GITHUB SECRETS (add in repo Settings > Secrets):
#
#   VPS_HOST              - VPS IP or hostname (e.g. 167.99.0.1)
#   VPS_USERNAME          - SSH user (e.g. root or deploy)
#   VPS_SSH_KEY           - Private SSH key (full PEM content)
#   VPS_PORT              - SSH port (e.g. 22)
#   APP_DIR               - Project path on VPS (e.g. /root/notification-service)
#
# NOTE: .env file with all app credentials (MongoDB, Redis, JWT, etc.)
#       must already exist on the VPS at APP_DIR/.env
#
# ═══════════════════════════════════════════════════════════

name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript build
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/server.js && test -f dist/worker.js
          echo "Build verified"

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "src/,package.json,package-lock.json,tsconfig.json,Dockerfile,docker-compose.prod.yml,.dockerignore"
          target: ${{ secrets.APP_DIR }}
          overwrite: true
          strip_components: 0

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd ${{ secrets.APP_DIR }}

            # ── Build & Deploy with Docker Compose ──
            # Dockerfile handles npm ci inside the container (no node_modules needed on host)
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d --scale worker=2 --remove-orphans

            # ── Cleanup old Docker images to save disk space ──
            docker image prune -f

            # ── Wait and verify health ──
            echo "Waiting for services to start..."
            sleep 10

            # Read PORT from existing .env, fallback to 5000
            APP_PORT=$(grep -E '^PORT=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '[:space:]')
            APP_PORT=${APP_PORT:-5000}

            if curl -sf http://localhost:$APP_PORT/health > /dev/null 2>&1; then
              echo "Deployment successful! Health check passed."
            else
              echo "WARNING: Health check failed. Checking container logs..."
              docker compose -f docker-compose.prod.yml logs --tail=30 api
              exit 1
            fi
