# ═══════════════════════════════════════════════════════════
# Deploy to VPS - Runs on push to main
#
# REQUIRED GITHUB SECRETS (add in repo Settings > Secrets):
#
#   VPS_HOST              - VPS IP or hostname (e.g. 167.99.0.1)
#   VPS_USERNAME          - SSH user (e.g. root or deploy)
#   VPS_SSH_KEY           - Private SSH key (full PEM content)
#   VPS_PORT              - SSH port (e.g. 22)
#   APP_DIR               - Project path on VPS (e.g. /root/notification-service)
#
# NOTE: .env file with all app credentials (MongoDB, Redis, JWT, etc.)
#       must already exist on the VPS at APP_DIR/.env
#
# ROLLBACK STRATEGY:
#   - Before every deploy, the current src/ is snapshotted to src.backup/
#   - If health check fails → backup is restored and containers are restarted
#   - Rollback result is posted as a GitHub commit status
# ═════════════════════════════════════════════════════════

- name: Deploy on VPS
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USERNAME }}
    key: ${{ secrets.VPS_SSH_KEY }}
    port: ${{ secrets.VPS_PORT }}
    command_timeout: 30m
    script: |
      set -e
      cd ${{ secrets.APP_DIR }}

      APP_PORT=$(grep -E '^PORT=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '[:space:]')
      APP_PORT=${APP_PORT:-5000}

      COMPOSE="docker-compose -f docker-compose.prod.yml"

      wait_for_health() {
        for i in $(seq 1 15); do
          if curl -sf http://localhost:$APP_PORT/health > /dev/null 2>&1; then
            return 0
          fi
          sleep 5
        done
        return 1
      }

      rm -rf src.backup
      [ -d src ] && cp -r src src.backup

      rollback() {
        rm -rf src
        cp -r src.backup src
        $COMPOSE build --no-cache
        $COMPOSE up -d --scale worker=2 --remove-orphans
        exit 1
      }

      trap rollback ERR

      docker pull mongo:7 || true
      docker pull redis:7-alpine || true

      $COMPOSE build --no-cache
      $COMPOSE up -d --scale worker=2 --remove-orphans

      docker image prune -f

      if wait_for_health; then
        rm -rf src.backup
      else
        rollback
      fi
